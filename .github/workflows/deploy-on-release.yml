name: Deploy on Release (Manual)

# Este workflow Ã© mais conservador:
# - Dispara APENAS quando vocÃª cria uma Release no GitHub
# - VocÃª tem controle total sobre quando publicar
# - Recomendado para produÃ§Ã£o

on:
  release:
    types: [published]  # Quando cria uma release com "Published"
  workflow_dispatch:    # Ou dispara manualmente via GitHub UI

jobs:
  build-and-submit:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          # Usa o commit da release, nÃ£o a branch
          ref: ${{ github.event.release.target_commitish || github.ref }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'corretto'
          java-version: '17'

      - name: ğŸ“š Instalar dependÃªncias
        run: npm ci

      - name: ğŸ—ï¸ Build APK com EAS
        env:
          EAS_TOKEN: ${{ secrets.EAS_TOKEN }}
        run: |
          npm install -g eas-cli
          eas build --platform android --profile production-apk --wait
        timeout-minutes: 40

      - name: ğŸ“¤ Submeter para Google Play
        env:
          EAS_TOKEN: ${{ secrets.EAS_TOKEN }}
          GOOGLE_PLAY_SA_KEY: ${{ secrets.GOOGLE_PLAY_SA_KEY }}
        run: |
          echo '${{ secrets.GOOGLE_PLAY_SA_KEY }}' > /tmp/google-play-sa-key.json
          eas submit \
            --platform android \
            --profile production-apk \
            --non-interactive
        timeout-minutes: 10

      - name: ğŸ“ Postar comentÃ¡rio na Release
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **Build & Deploy Completo!**
              
              - âœ¨ APK/AAB gerado com sucesso
              - ğŸ“¤ Submetido para Google Play
              - ğŸ• Status: Em preparaÃ§Ã£o para revisÃ£o
              
              Acesse: https://play.google.com/console para acompanhar`
            })

      - name: âŒ Postar erro na Release
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **Build falhou!**
              
              Verifique os logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            })
